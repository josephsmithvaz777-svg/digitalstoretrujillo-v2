---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ProductCard from "../components/ProductCard.astro";
import { searchProducts } from "../lib/supabase";

// Get search query from URL
const query = Astro.url.searchParams.get("q") || "";

// Fetch search results
const products = query ? await searchProducts(query) : [];

const title = query
    ? `Search results for "${query}" - DigitalStoreTrujillo`
    : "Search - DigitalStoreTrujillo";
const description = `Search results for ${query} in our digital store.`;
---

<Layout title={title} description={description}>
    <Header />

    <main class="layout-container flex h-full grow flex-col">
        <div class="px-4 md:px-10 lg:px-40 flex flex-1 justify-center py-5">
            <div
                class="layout-content-container flex flex-col max-w-[1200px] flex-1"
            >
                <!-- Breadcrumb -->
                <nav
                    class="flex text-sm text-text-muted mb-4 gap-2 items-center mt-4"
                >
                    <a
                        href="/"
                        class="hover:text-primary transition-colors flex items-center gap-1"
                    >
                        <span class="material-symbols-outlined text-[18px]"
                            >home</span
                        >
                        Home
                    </a>
                    <span class="text-border-dark">/</span>
                    <span class="text-white font-medium">Search</span>
                </nav>

                <!-- Search Header -->
                <div class="mb-8">
                    <h1
                        class="text-4xl md:text-5xl font-black text-white leading-tight tracking-tight"
                    >
                        Search Results
                    </h1>
                    {
                        query && (
                            <p class="text-lg text-text-muted mt-2">
                                Showing results for{" "}
                                <span class="text-primary font-bold">
                                    "{query}"
                                </span>
                                {products.length > 0 && (
                                    <span>
                                        {" "}
                                        - {products.length} product
                                        {products.length !== 1 ? "s" : ""} found
                                    </span>
                                )}
                            </p>
                        )
                    }
                    {
                        !query && (
                            <p class="text-lg text-text-muted mt-2">
                                Enter a search term to find products
                            </p>
                        )
                    }
                </div>

                <div
                    class="w-full h-px bg-gradient-to-r from-primary/50 via-border-dark to-transparent mb-12"
                >
                </div>

                <!-- Search Results Grid -->
                <section
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-20"
                >
                    {
                        products.length > 0 ? (
                            products.map((product) => (
                                <ProductCard
                                    title={product.title}
                                    price={product.price}
                                    pricePEN={product.price_pen ?? undefined}
                                    originalPrice={
                                        product.original_price ?? undefined
                                    }
                                    originalPricePEN={
                                        product.original_price_pen ?? undefined
                                    }
                                    renewablePrice={
                                        product.renewable_price ?? undefined
                                    }
                                    renewablePricePEN={
                                        product.renewable_price_pen ?? undefined
                                    }
                                    image={product.image}
                                    badge={product.badge ?? undefined}
                                    badgeColor={
                                        product.badge_color ?? undefined
                                    }
                                    badgeTextColor={
                                        product.badge_text_color ?? undefined
                                    }
                                    showBadge={product.show_badge}
                                    discountBadge={
                                        product.discount_badge ?? undefined
                                    }
                                    discountBadgeColor={
                                        product.discount_badge_color ??
                                        undefined
                                    }
                                    discountBadgeTextColor={
                                        product.discount_badge_text_color ??
                                        undefined
                                    }
                                    showDiscountBadge={
                                        product.show_discount_badge
                                    }
                                    showRenewablePrice={
                                        product.show_renewable_price
                                    }
                                    seller={product.seller ?? undefined}
                                    rating={product.rating}
                                    reviewCount={product.review_count}
										stockQuantity={product.stock_quantity}
                                    productUrl={`/product/${product.slug}`}
                                    inStock={product.in_stock}
                                />
                            ))
                        ) : query ? (
                            <div class="col-span-full py-24 text-center bg-card-dark/30 border border-border-dark rounded-3xl">
                                <span class="material-symbols-outlined text-7xl text-border-dark mb-4 drop-shadow-lg">
                                    search_off
                                </span>
                                <h2 class="text-2xl font-bold text-white mb-2">
                                    No results found
                                </h2>
                                <p class="text-text-muted max-w-md mx-auto mb-8">
                                    We couldn't find any products matching "
                                    <span class="text-primary font-bold">
                                        {query}
                                    </span>
                                    ". Try searching with different keywords or
                                    browse our categories.
                                </p>
                                <a
                                    href="/"
                                    class="inline-flex items-center gap-2 px-8 py-4 bg-primary text-white font-black rounded-xl hover:bg-red-700 transition-all transform hover:scale-105 shadow-xl shadow-primary/20"
                                >
                                    <span class="material-symbols-outlined">
                                        arrow_back
                                    </span>
                                    BACK TO STORE
                                </a>
                            </div>
                        ) : (
                            <div class="col-span-full py-24 text-center bg-card-dark/30 border border-border-dark rounded-3xl">
                                <span class="material-symbols-outlined text-7xl text-border-dark mb-4 drop-shadow-lg">
                                    search
                                </span>
                                <h2 class="text-2xl font-bold text-white mb-2">
                                    Start searching
                                </h2>
                                <p class="text-text-muted max-w-md mx-auto mb-8">
                                    Use the search box above to find products by
                                    name, description, or category.
                                </p>
                            </div>
                        )
                    }
                </section>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

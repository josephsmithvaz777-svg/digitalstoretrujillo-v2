---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProductCard from "../../components/ProductCard.astro";
import AddToCartButton from "../../components/AddToCartButton.astro";
import { getProductBySlug } from "../../lib/supabase";

// Get the slug from the URL params
const { slug } = Astro.params;

// Fetch product data dynamically
const product = await getProductBySlug(slug as string);

if (!product) {
    console.error(`Product not found for slug: ${slug}`);
    return Astro.redirect("/");
}

// Fetch related products (same category, excluding current)
import { getProductsByCategory } from "../../lib/supabase";
const allCategoryProducts = await getProductsByCategory(product.category);
const relatedProducts = allCategoryProducts
    .filter((p: any) => p.id !== product.id)
    .slice(0, 4);

const title = `${product.title} - DigitalStoreTrujillo`;
const description = product.description || "";
---

<Layout title={title} description={description}>
    <Header />

    <main class="layout-container flex h-full grow flex-col">
        <div class="px-4 md:px-10 lg:px-40 flex flex-1 justify-center py-5">
            <div
                class="layout-content-container flex flex-col max-w-[1200px] flex-1"
            >
                <!-- Breadcrumbs -->
                <div class="flex flex-wrap gap-2 p-4 mb-4">
                    <a
                        class="text-text-muted hover:text-white transition-colors text-sm font-medium leading-normal"
                        data-i18n="prod_breadcrumb_home"
                        href="/">Home</a
                    >
                    <span
                        class="text-text-muted text-sm font-medium leading-normal"
                        >/</span
                    >
                    <a
                        class="text-text-muted hover:text-white transition-colors text-sm font-medium leading-normal"
                        href={`/category/${product.category.toLowerCase()}`}
                        >{product.category}</a
                    >
                    <span
                        class="text-text-muted text-sm font-medium leading-normal"
                        >/</span
                    >
                    <span class="text-white text-sm font-medium leading-normal"
                        >{product.title}</span
                    >
                </div>

                <!-- Product Detail Section -->
                <div
                    class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 px-4 pb-12"
                >
                    <!-- Left Column: Images -->
                    <div class="lg:col-span-7 flex flex-col gap-4">
                        <div
                            class="relative w-full aspect-square overflow-hidden rounded-2xl bg-[#0f0f0f] border border-border-dark group flex items-center justify-center p-4 lg:p-8"
                        >
                            <!-- Ambient Background Glow -->
                            <div
                                class="absolute inset-0 bg-center bg-cover blur-[80px] opacity-20 scale-150 transition-opacity duration-500 group-hover:opacity-30"
                                style={`background-image: url("${product.image}");`}
                            >
                            </div>

                            <!-- Main Product Image -->
                            <img
                                src={product.image}
                                class="relative z-10 w-full h-full object-contain transition-transform duration-500 group-hover:scale-[1.03] drop-shadow-[0_20px_50px_rgba(0,0,0,0.5)]"
                                alt={product.title}
                            />

                            <!-- Badges Overlay -->
                            <div
                                class="absolute top-6 left-6 flex flex-wrap gap-2 z-20"
                            >
                                {
                                    product.discount_badge &&
                                        product.show_discount_badge && (
                                            <span
                                                class="text-[10px] md:text-xs font-black px-3 py-1.5 rounded-lg shadow-xl uppercase tracking-wider backdrop-blur-md"
                                                style={`background-color: ${product.discount_badge_color || "rgba(224, 7, 0, 0.9)"}; color: ${product.discount_badge_text_color || "#FFFFFF"}`}
                                            >
                                                {product.discount_badge}
                                            </span>
                                        )
                                }
                                {
                                    product.badge && product.show_badge && (
                                        <span
                                            class="text-[10px] md:text-xs font-black px-3 py-1.5 rounded-lg shadow-xl uppercase tracking-wider backdrop-blur-md"
                                            style={`background-color: ${product.badge_color || "rgba(255, 215, 0, 0.9)"}; color: ${product.badge_text_color || "#000000"}`}
                                        >
                                            {product.badge}
                                        </span>
                                    )
                                }
                            </div>
                        </div>
                        <!-- Thumbnails (Only if show_gallery is true) -->
                        {
                            product.show_gallery &&
                                product.thumbnails.length > 0 && (
                                    <div class="flex gap-4 overflow-x-auto pb-2">
                                        {product.thumbnails.map(
                                            (thumb: string, index: number) => (
                                                <button
                                                    class={`w-24 h-24 flex-shrink-0 rounded-lg border overflow-hidden relative transition-all ${index === 0 ? "border-2 border-primary" : "border border-border-dark hover:border-text-muted opacity-70 hover:opacity-100"}`}
                                                >
                                                    <div
                                                        class="w-full h-full bg-center bg-cover"
                                                        style={`background-image: url("${thumb}");`}
                                                    />
                                                </button>
                                            ),
                                        )}
                                    </div>
                                )
                        }
                    </div>

                    <!-- Right Column: Details & Purchase -->
                    <div class="lg:col-span-5 flex flex-col gap-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class="material-symbols-outlined text-yellow-500 text-lg"
                                    style="font-variation-settings: 'FILL' 1"
                                    >star</span
                                >
                                <span class="text-white font-bold text-sm"
                                    >{product.rating}.0</span
                                >
                                <span class="text-text-muted text-sm"
                                    >(<span class="prod-review-count"
                                        >{product.review_count}</span
                                    >
                                    <span class="prod-reviews-label"
                                        >reviews</span
                                    >)</span
                                >
                            </div>
                            <div
                                class="flex items-start justify-between gap-4 mb-2"
                            >
                                <h1
                                    class="text-white text-3xl md:text-4xl font-bold leading-tight"
                                >
                                    {product.title}
                                </h1>
                                <button
                                    id="share-product-btn"
                                    class="flex-shrink-0 w-10 h-10 rounded-full bg-card-dark border border-border-dark flex items-center justify-center text-text-muted hover:text-white hover:border-white transition-all transform active:scale-95 shadow-lg group"
                                    title="Share Product"
                                >
                                    <span
                                        class="material-symbols-outlined text-[20px]"
                                        >share</span
                                    >
                                </button>
                            </div>
                            <p
                                class="text-text-muted text-base leading-relaxed"
                            >
                                {product.description}
                            </p>
                        </div>

                        <!-- Price and Stock -->
                        <div
                            class="p-5 rounded-xl bg-card-dark border border-border-dark"
                        >
                            <div class="flex items-end gap-3 mb-4">
                                <p
                                    class="text-4xl font-bold text-white product-price"
                                    data-price-usd={product.price}
                                    data-price-pen={product.price_pen}
                                >
                                    {product.price.toFixed(2)}
                                </p>
                                {
                                    product.original_price && (
                                        <p
                                            class="text-xl text-text-m uted line-through mb-1 product-original-price"
                                            data-price-usd={
                                                product.original_price
                                            }
                                            data-price-pen={
                                                product.original_price_pen
                                            }
                                        >
                                            ${" "}
                                            {product.original_price.toFixed(2)}
                                        </p>
                                    )
                                }
                                <span
                                    class="mb-1 ml-auto bg-green-500/20 text-green-400 text-xs font-bold px-2 py-1 rounded border border-green-500/30"
                                    data-i18n="product_in_stock"
                                >
                                    IN STOCK
                                </span>
                            </div>
                            {
                                product.renewable_price &&
                                    product.show_renewable_price && (
                                        <div class="flex items-center gap-2 text-sm mb-4">
                                            <span class="material-symbols-outlined text-green-500 text-lg">
                                                autorenew
                                            </span>
                                            <span
                                                class="text-green-400 font-semibold product-renewable-price"
                                                data-price-usd={
                                                    product.renewable_price
                                                }
                                                data-price-pen={
                                                    product.renewable_price_pen
                                                }
                                            >
                                                Renovable: $
                                                {product.renewable_price.toFixed(
                                                    2,
                                                )}
                                            </span>
                                        </div>
                                    )
                            }
                            <div
                                class="flex items-center gap-2 text-sm text-text-muted mb-6"
                            >
                                <span
                                    class="material-symbols-outlined text-primary text-lg"
                                    >bolt</span
                                >
                                <span data-i18n="prod_instant_delivery"
                                    >Instant delivery via email</span
                                >
                            </div>
                            <div class="flex flex-col gap-4">
                                <!-- Quantity -->
                                <div class="flex items-center justify-between">
                                    <span
                                        class="text-sm font-medium text-white prod-quantity-label"
                                        >Quantity</span
                                    >
                                    <div
                                        class="flex items-center rounded-lg bg-background-dark border border-border-dark h-10"
                                    >
                                        <button
                                            class="w-10 h-full flex items-center justify-center text-text-muted hover:text-white hover:bg-border-dark rounded-l-lg transition-colors"
                                        >
                                            <span
                                                class="material-symbols-outlined text-sm"
                                                >remove</span
                                            >
                                        </button>
                                        <input
                                            class="w-12 h-full bg-transparent border-none text-center text-white focus:ring-0 p-0 text-sm font-bold"
                                            readonly
                                            type="text"
                                            value="1"
                                        />
                                        <button
                                            class="w-10 h-full flex items-center justify-center text-text-muted hover:text-white hover:bg-border-dark rounded-r-lg transition-colors"
                                        >
                                            <span
                                                class="material-symbols-outlined text-sm"
                                                >add</span
                                            >
                                        </button>
                                    </div>
                                </div>
                                <!-- Action Buttons -->
                                <AddToCartButton
                                    productId={product.id}
                                    productTitle={product.title}
                                    productPrice={product.price}
                                    productPricePEN={product.price_pen ??
                                        undefined}
                                    productImage={product.image}
                                    productSeller={product.seller ?? undefined}
                                    className="w-full bg-primary hover:bg-red-700 text-white font-bold py-3.5 rounded-lg transition-all transform active:scale-[0.98] shadow-[0_0_15px_rgba(224,7,0,0.3)] flex items-center justify-center gap-2"
                                />
                                <button
                                    id="buy-now-btn"
                                    data-product-id={product.id}
                                    data-product-title={product.title}
                                    data-product-price={product.price}
                                    data-product-price-pen={product.price_pen}
                                    data-product-image={product.image}
                                    data-product-seller={product.seller ??
                                        undefined}
                                    class="w-full bg-transparent border-2 border-border-dark hover:border-white text-white font-bold py-3.5 rounded-lg transition-colors prod-buy-now-btn"
                                >
                                    Buy Now
                                </button>
                            </div>
                        </div>

                        <!-- Payment Methods -->
                        <div class="flex flex-col gap-3">
                            <p
                                class="text-xs font-bold text-text-muted uppercase tracking-wider prod-secure-payment-label"
                            >
                                Secure Payment with
                            </p>
                            <div class="flex flex-wrap gap-2">
                                <!-- Yape -->
                                <div
                                    class="h-10 px-4 rounded-lg bg-[#722F91] flex items-center justify-center gap-2 shadow-md"
                                    title="Yape"
                                >
                                    <img
                                        src="/assets/yape-logo.svg"
                                        alt="Yape"
                                        class="w-5 h-5 object-contain"
                                    />
                                    <span class="text-white font-bold text-sm"
                                        >Yape</span
                                    >
                                </div>
                                <!-- PayPal -->
                                <div
                                    class="h-10 px-4 rounded-lg bg-[#0070ba] flex items-center justify-center gap-2 shadow-md"
                                    title="PayPal"
                                >
                                    <img
                                        src="/assets/paypal-icon.svg"
                                        alt="PayPal"
                                        class="w-5 h-5 object-contain"
                                    />
                                    <span class="text-white font-bold text-sm"
                                        >PayPal</span
                                    >
                                </div>
                                <!-- Binance Pay -->
                                <div
                                    class="h-10 px-4 rounded-lg bg-[#F3BA2F] flex items-center justify-center gap-2 shadow-md"
                                    title="Binance Pay"
                                >
                                    <img
                                        src="/assets/binance-icon-black.svg"
                                        alt="Binance"
                                        class="w-5 h-5 object-contain"
                                    />
                                    <span class="text-black font-bold text-sm"
                                        >Binance</span
                                    >
                                </div>
                                <!-- Cryptomus -->
                                <div
                                    class="h-10 px-4 rounded-lg bg-[#1e293b] border border-slate-700 flex items-center justify-center gap-2 shadow-md"
                                    title="Cryptomus"
                                >
                                    <img
                                        src="/assets/Cryptomus_icon.svg"
                                        alt="Cryptomus"
                                        class="w-4 h-4 object-contain"
                                    />
                                    <span class="text-white font-bold text-sm"
                                        >Cryptomus</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Origin & Support Info -->
                <div
                    class="px-4 py-8 border-t border-border-dark bg-[#2d1414]/50 rounded-xl"
                >
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Origin Info -->
                        <div
                            class="bg-card-dark border border-border-dark rounded-lg p-5"
                        >
                            <div class="flex items-center gap-3 mb-3">
                                <span
                                    class="material-symbols-outlined text-primary text-2xl"
                                    >verified</span
                                >
                                <h3
                                    class="text-white text-lg font-bold prod-origin-title"
                                >
                                    Origen del Producto
                                </h3>
                            </div>
                            <p
                                class="text-text-muted text-sm leading-relaxed prod-origin-text"
                            >
                                Este producto proviene de <strong
                                    class="text-white"
                                    >marketplaces oficiales verificados</strong
                                > como G2A Goldmine, Eneba, o Keysforgames. Todas
                                las claves y licencias son obtenidas legítimamente
                                a través de programas de afiliados y tiendas autorizadas.
                            </p>
                        </div>

                        <!-- Support Info -->
                        <div
                            class="bg-card-dark border border-border-dark rounded-lg p-5"
                        >
                            <div class="flex items-center gap-3 mb-3">
                                <span
                                    class="material-symbols-outlined text-primary text-2xl"
                                    >support_agent</span
                                >
                                <h3
                                    class="text-white text-lg font-bold prod-support-title"
                                >
                                    Soporte y Garantía
                                </h3>
                            </div>
                            <p
                                class="text-text-muted text-sm leading-relaxed prod-support-text"
                            >
                                Verificamos cada producto antes de la entrega.
                                <strong class="text-white"
                                    >Soporte completo 24-48 horas</strong
                                > después de la compra. Si tienes algún problema con
                                tu clave o servicio, contáctanos y lo resolveremos
                                o reemplazaremos sin costo.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Product Features -->
                <div class="px-4 py-8 border-t border-border-dark">
                    <h3
                        class="text-white text-xl font-bold mb-4 prod-features-title"
                    >
                        Key Features
                    </h3>
                    <ul class="list-disc pl-5 space-y-2 text-text-muted">
                        {
                            product.features.map((feature: string) => (
                                <li>{feature}</li>
                            ))
                        }
                    </ul>
                </div>

                <!-- Related Products -->
                <div class="px-4 py-12">
                    <h2
                        class="text-2xl font-bold text-white mb-6 prod-related-title"
                    >
                        Related Products
                    </h2>
                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
                    >
                        {
                            relatedProducts.map((p: any) => (
                                <ProductCard
                                    title={p.title}
                                    price={p.price}
                                    pricePEN={p.price_pen}
                                    originalPrice={p.original_price}
                                    originalPricePEN={p.original_price_pen}
                                    renewablePrice={p.renewable_price}
                                    renewablePricePEN={p.renewable_price_pen}
                                    image={p.image}
                                    seller={p.seller ?? undefined}
                                    rating={p.rating}
                                    reviewCount={p.review_count}
                                    productUrl={`/product/${p.slug}`}
                                    inStock={p.in_stock}
                                />
                            ))
                        }
                        {
                            relatedProducts.length === 0 && (
                                <p class="col-span-full text-center text-text-muted py-8">
                                    No related products found.
                                </p>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </main>

    <Footer />

    <script>
        import { addToCart } from "../../stores/cart";
        import {
            initializeCurrency,
            userCurrency,
        } from "../../stores/currencyStore";
        import { getPrice, CURRENCIES } from "../../lib/currency";
        import {
            currentLanguage,
            useTranslation,
            initializeLanguage,
        } from "../../stores/i18nStore";

        document.addEventListener("DOMContentLoaded", () => {
            // Initialize stores
            initializeCurrency();
            initializeLanguage();

            // Update prices when currency changes
            const updatePrices = () => {
                const currency = userCurrency.get();
                const symbol = CURRENCIES[currency].symbol;
                const t = useTranslation();

                // Main price
                const mainPriceEl = document.querySelector(".product-price");
                if (mainPriceEl) {
                    const priceUSDAttr =
                        mainPriceEl.getAttribute("data-price-usd");
                    const pricePENAttr =
                        mainPriceEl.getAttribute("data-price-pen");

                    const priceUSD = parseFloat(priceUSDAttr || "0");
                    const pricePEN =
                        pricePENAttr &&
                        pricePENAttr !== "null" &&
                        pricePENAttr !== "undefined"
                            ? parseFloat(pricePENAttr)
                            : null;

                    const price = getPrice(priceUSD, pricePEN, currency);
                    mainPriceEl.textContent = `${symbol} ${price.toFixed(2)}`;
                }

                // Original price
                const originalPriceEl = document.querySelector(
                    ".product-original-price",
                );
                if (originalPriceEl) {
                    const priceUSDAttr =
                        originalPriceEl.getAttribute("data-price-usd");
                    const pricePENAttr =
                        originalPriceEl.getAttribute("data-price-pen");

                    const priceUSD = parseFloat(priceUSDAttr || "0");
                    const pricePEN =
                        pricePENAttr &&
                        pricePENAttr !== "null" &&
                        pricePENAttr !== "undefined"
                            ? parseFloat(pricePENAttr)
                            : null;

                    const price = getPrice(priceUSD, pricePEN, currency);
                    originalPriceEl.textContent = `${symbol} ${price.toFixed(2)}`;
                }

                // Renewable price
                const renewablePriceEl = document.querySelector(
                    ".product-renewable-price",
                );
                if (renewablePriceEl) {
                    const priceUSDAttr =
                        renewablePriceEl.getAttribute("data-price-usd");
                    const pricePENAttr =
                        renewablePriceEl.getAttribute("data-price-pen");

                    const priceUSD = parseFloat(priceUSDAttr || "0");
                    const pricePEN =
                        pricePENAttr &&
                        pricePENAttr !== "null" &&
                        pricePENAttr !== "undefined"
                            ? parseFloat(pricePENAttr)
                            : null;

                    const price = getPrice(priceUSD, pricePEN, currency);
                    renewablePriceEl.textContent = `${t("product_renewable")}: ${symbol} ${price.toFixed(2)}`;
                }
            };

            const updateTranslations = () => {
                const t = useTranslation();

                // Breadcrumbs
                const homeBreadcrumb = document.querySelector(
                    ".prod-breadcrumb-home",
                );
                if (homeBreadcrumb)
                    homeBreadcrumb.textContent = t("prod_breadcrumb_home");

                // Reviews
                const reviewsLabel = document.querySelector(
                    ".prod-reviews-label",
                );
                if (reviewsLabel) reviewsLabel.textContent = t("prod_reviews");

                // Stock
                const stockBadge = document.querySelector(".prod-stock-badge");
                if (stockBadge) stockBadge.textContent = t("prod_in_stock");

                // Delivery
                const deliveryText = document.querySelector(
                    ".prod-delivery-text",
                );
                if (deliveryText)
                    deliveryText.textContent = t("prod_instant_delivery");

                // Quantity
                const quantityLabel = document.querySelector(
                    ".prod-quantity-label",
                );
                if (quantityLabel)
                    quantityLabel.textContent = t("prod_quantity");

                // Buttons
                const buyNowBtn = document.querySelector(".prod-buy-now-btn");
                if (buyNowBtn) buyNowBtn.textContent = t("prod_buy_now");

                // Secure Payment
                const secureLabel = document.querySelector(
                    ".prod-secure-payment-label",
                );
                if (secureLabel)
                    secureLabel.textContent = t("prod_secure_payment");

                // Info Sections
                const originTitle =
                    document.querySelector(".prod-origin-title");
                const originText = document.querySelector(".prod-origin-text");
                if (originTitle)
                    originTitle.textContent = t("prod_origin_title");
                if (originText)
                    originText.innerHTML = t("prod_origin_text").replace(
                        "verified official marketplaces",
                        "<strong>marketplaces oficiales verificados</strong>",
                    );

                const supportTitle = document.querySelector(
                    ".prod-support-title",
                );
                const supportText =
                    document.querySelector(".prod-support-text");
                if (supportTitle)
                    supportTitle.textContent = t("prod_support_title");
                if (supportText)
                    supportText.innerHTML = t("prod_support_text").replace(
                        "24-48 hours full support",
                        "<strong>Soporte completo 24-48 horas</strong>",
                    );

                const featuresTitle = document.querySelector(
                    ".prod-features-title",
                );
                if (featuresTitle)
                    featuresTitle.textContent = t("prod_features_title");

                const relatedTitle = document.querySelector(
                    ".prod-related-title",
                );
                if (relatedTitle)
                    relatedTitle.textContent = t("prod_related_title");

                // Update prices prefix
                updatePrices();
            };

            // Subscribe to changes
            userCurrency.subscribe(updatePrices);
            currentLanguage.subscribe(updateTranslations);

            window.addEventListener("currency-changed", updatePrices);
            window.addEventListener("language-changed", updateTranslations);

            const buyNowBtn = document.getElementById("buy-now-btn");

            if (buyNowBtn) {
                buyNowBtn.addEventListener("click", (e) => {
                    const btn = e.currentTarget as HTMLButtonElement;
                    const productId = btn.dataset.productId!;
                    const productTitle = btn.dataset.productTitle!;
                    const productPrice = parseFloat(btn.dataset.productPrice!);
                    const productPricePEN = btn.dataset.productPricePen
                        ? parseFloat(btn.dataset.productPricePen)
                        : undefined;
                    const productImage = btn.dataset.productImage!;
                    const productSeller = btn.dataset.productSeller;

                    // Add to cart
                    addToCart({
                        id: productId,
                        title: productTitle,
                        price: productPrice,
                        price_pen: productPricePEN,
                        image: productImage,
                        seller: productSeller,
                    });

                    // Redirect to cart
                    window.location.href = "/cart";
                });
            }

            const shareBtn = document.getElementById("share-product-btn");
            if (shareBtn) {
                shareBtn.addEventListener("click", async () => {
                    const title = document.title;
                    const url = window.location.href;

                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: title,
                                text: `¡Mira este producto en Digital Store Trujillo!`,
                                url: url,
                            });
                        } catch (err) {
                            console.log("Error sharing:", err);
                        }
                    } else {
                        // Fallback to clipboard
                        try {
                            await navigator.clipboard.writeText(url);
                            alert("¡Enlace copiado al portapapeles!");
                        } catch (err) {
                            console.error("Failed to copy:", err);
                        }
                    }
                });
            }
        });
    </script>
</Layout>

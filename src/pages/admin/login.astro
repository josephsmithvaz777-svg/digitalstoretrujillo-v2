---
import Layout from "../../layouts/Layout.astro";

const title = "Admin Login - DigitalStoreTrujillo";
const description = "Acceso al panel de administraci√≥n";
---

<Layout title={title} description={description}>
    <main
        class="min-h-screen flex items-center justify-center px-4 py-12 bg-background-dark"
    >
        <div class="max-w-md w-full space-y-8">
            <!-- Logo/Header -->
            <div class="text-center">
                <div
                    class="mx-auto h-16 w-16 bg-primary rounded-xl flex items-center justify-center mb-4"
                >
                    <span class="material-symbols-outlined text-white text-3xl"
                        >admin_panel_settings</span
                    >
                </div>
                <h2 class="text-3xl font-black text-white tracking-tight">
                    Admin Dashboard
                </h2>
                <p class="mt-2 text-sm text-text-muted">
                    Inicia sesi√≥n para acceder al panel de administraci√≥n
                </p>
            </div>

            <!-- Login Form -->
            <div
                class="bg-card-dark border border-border-dark rounded-xl p-8 shadow-lg"
            >
                <form id="login-form" class="space-y-6">
                    <!-- Email -->
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-white mb-2"
                        >
                            Email
                        </label>
                        <input
                            id="email"
                            name="email"
                            type="email"
                            autocomplete="email"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            inputmode="email"
                            required
                            class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            placeholder="admin@digitalstoretrujillo.store"
                        />
                    </div>

                    <!-- Password -->
                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-white mb-2"
                        >
                            Contrase√±a
                        </label>
                        <div class="relative">
                            <input
                                id="password"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                autocapitalize="off"
                                autocorrect="off"
                                spellcheck="false"
                                required
                                class="w-full px-4 py-3 pr-12 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            />
                            <button
                                type="button"
                                id="toggle-password"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-text-muted hover:text-white transition-colors p-1"
                                aria-label="Mostrar contrase√±a"
                            >
                                <span class="material-symbols-outlined text-xl"
                                    >visibility</span
                                >
                            </button>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div
                        id="error-message"
                        class="hidden bg-red-500/10 border border-red-500/30 rounded-lg p-3"
                    >
                        <p class="text-red-400 text-sm"></p>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full flex justify-center items-center gap-2 py-3 px-4 bg-primary hover:bg-red-700 text-white font-bold rounded-lg transition-all transform active:scale-[0.98] shadow-lg shadow-primary/20"
                    >
                        <span class="material-symbols-outlined">login</span>
                        Iniciar Sesi√≥n
                    </button>
                </form>
            </div>

            <!-- Back to Home -->
            <div class="text-center">
                <a
                    href="/"
                    class="inline-flex items-center gap-2 text-sm text-text-muted hover:text-primary transition-colors"
                >
                    <span class="material-symbols-outlined text-[18px]"
                        >arrow_back</span
                    >
                    Volver a la tienda
                </a>
            </div>
        </div>
    </main>

    <script>
        import { signInAdmin, supabase } from "../../lib/supabase";

        // Check if admin is already logged in
        (async () => {
            const {
                data: { session },
            } = await supabase.auth.getSession();
            if (session) {
                const {
                    data: { user },
                } = await supabase.auth.getUser();
                if (user?.email === "admin@digitalstoretrujillo.store") {
                    // Already logged in as admin, redirect to panel
                    window.location.href = "/admin/products";
                }
            }
        })();

        const form = document.getElementById("login-form") as HTMLFormElement;
        const emailInput = document.getElementById("email") as HTMLInputElement;
        const passwordInput = document.getElementById(
            "password",
        ) as HTMLInputElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const errorMessage = document.getElementById("error-message");
        const togglePasswordBtn = document.getElementById("toggle-password");

        // Toggle password visibility
        togglePasswordBtn?.addEventListener("click", () => {
            const icon = togglePasswordBtn.querySelector("span");
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                if (icon) icon.textContent = "visibility_off";
            } else {
                passwordInput.type = "password";
                if (icon) icon.textContent = "visibility";
            }
        });

        // Prevent autocomplete from adding spaces on mobile
        emailInput?.addEventListener("blur", () => {
            if (emailInput.value) {
                emailInput.value = emailInput.value.trim().toLowerCase();
            }
        });

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            // Trim and sanitize inputs to prevent mobile autocomplete issues
            const email = (formData.get("email") as string)
                ?.trim()
                .toLowerCase();
            const password = (formData.get("password") as string)?.trim();

            // Basic validation
            if (!email || !password) {
                if (errorMessage) {
                    const errorText = errorMessage.querySelector("p");
                    if (errorText) {
                        errorText.textContent =
                            "Por favor, completa todos los campos.";
                    }
                    errorMessage.classList.remove("hidden");
                }
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                if (errorMessage) {
                    const errorText = errorMessage.querySelector("p");
                    if (errorText) {
                        errorText.textContent =
                            "Por favor, ingresa un email v√°lido.";
                    }
                    errorMessage.classList.remove("hidden");
                }
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
				<span class="material-symbols-outlined animate-spin">progress_activity</span>
				Iniciando sesi√≥n...
			`;

            // Hide previous errors
            errorMessage?.classList.add("hidden");

            try {
                console.log("üîê Attempting login with email:", email);
                console.log("üì± User Agent:", navigator.userAgent);
                console.log("üåç Online status:", navigator.onLine);

                const { user, error } = await signInAdmin(email, password);

                if (error) {
                    console.error("‚ùå Login error:", error);
                    console.error("Error code:", error.message);
                    console.error("Error status:", error.status);
                    throw new Error(error.message || "Error al iniciar sesi√≥n");
                }

                if (!user) {
                    console.error("‚ùå No user returned from signInAdmin");
                    throw new Error(
                        "Error al iniciar sesi√≥n - usuario no encontrado",
                    );
                }

                console.log("‚úÖ Login successful for:", user.email);

                // Success - redirect to admin panel
                // Add a small delay to ensure session is saved
                setTimeout(() => {
                    window.location.href = "/admin/products";
                }, 500);
            } catch (error: any) {
                console.error("‚ùå Login failed:", error);

                // Show error
                if (errorMessage) {
                    const errorText = errorMessage.querySelector("p");
                    if (errorText) {
                        let errorMsg =
                            "Credenciales incorrectas. Por favor, intenta de nuevo.";

                        // Provide more specific error messages
                        if (
                            error.message?.includes("Invalid login credentials")
                        ) {
                            errorMsg =
                                "Email o contrase√±a incorrectos. Verifica tus credenciales.";
                        } else if (
                            error.message?.includes("Email not confirmed")
                        ) {
                            errorMsg =
                                "Tu email no ha sido confirmado. Contacta al administrador.";
                        } else if (
                            error.message?.includes("Too many requests")
                        ) {
                            errorMsg =
                                "Demasiados intentos. Espera unos minutos e intenta de nuevo.";
                        } else if (error.message?.includes("Network")) {
                            errorMsg =
                                "Error de conexi√≥n. Verifica tu internet e intenta de nuevo.";
                        } else if (error.message) {
                            // Use the actual error message for better debugging
                            errorMsg = error.message;
                        }

                        errorText.textContent = errorMsg;
                    }
                    errorMessage.classList.remove("hidden");
                }

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
					<span class="material-symbols-outlined">login</span>
					Iniciar Sesi√≥n
				`;
            }
        });
    </script>
</Layout>

---
import Layout from "../../layouts/Layout.astro";

const title = "Admin Login - DigitalStoreTrujillo";
const description = "Acceso al panel de administración";
---

<Layout title={title} description={description}>
    <main
        class="min-h-screen flex items-center justify-center px-4 py-12 bg-background-dark"
    >
        <div class="max-w-md w-full space-y-8">
            <!-- Logo/Header -->
            <div class="text-center">
                <div
                    class="mx-auto h-16 w-16 bg-primary rounded-xl flex items-center justify-center mb-4"
                >
                    <span class="material-symbols-outlined text-white text-3xl"
                        >admin_panel_settings</span
                    >
                </div>
                <h2 class="text-3xl font-black text-white tracking-tight">
                    Admin Dashboard
                </h2>
                <p class="mt-2 text-sm text-text-muted">
                    Inicia sesión para acceder al panel de administración
                </p>
            </div>

            <!-- Login Form -->
            <div
                class="bg-card-dark border border-border-dark rounded-xl p-8 shadow-lg"
            >
                <form id="login-form" class="space-y-6">
                    <!-- Email -->
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-white mb-2"
                        >
                            Email
                        </label>
                        <input
                            id="email"
                            name="email"
                            type="email"
                            autocomplete="email"
                            required
                            class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            placeholder="admin@digitalstoretrujillo.com"
                        />
                    </div>

                    <!-- Password -->
                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-white mb-2"
                        >
                            Contraseña
                        </label>
                        <input
                            id="password"
                            name="password"
                            type="password"
                            autocomplete="current-password"
                            required
                            class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                            placeholder="••••••••"
                        />
                    </div>

                    <!-- Error Message -->
                    <div
                        id="error-message"
                        class="hidden bg-red-500/10 border border-red-500/30 rounded-lg p-3"
                    >
                        <p class="text-red-400 text-sm"></p>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full flex justify-center items-center gap-2 py-3 px-4 bg-primary hover:bg-red-700 text-white font-bold rounded-lg transition-all transform active:scale-[0.98] shadow-lg shadow-primary/20"
                    >
                        <span class="material-symbols-outlined">login</span>
                        Iniciar Sesión
                    </button>
                </form>
            </div>

            <!-- Back to Home -->
            <div class="text-center">
                <a
                    href="/"
                    class="inline-flex items-center gap-2 text-sm text-text-muted hover:text-primary transition-colors"
                >
                    <span class="material-symbols-outlined text-[18px]"
                        >arrow_back</span
                    >
                    Volver a la tienda
                </a>
            </div>
        </div>
    </main>

    <script>
        import { signInAdmin } from "../../lib/supabase";

        const form = document.getElementById("login-form") as HTMLFormElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const errorMessage = document.getElementById("error-message");

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const email = formData.get("email") as string;
            const password = formData.get("password") as string;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
				<span class="material-symbols-outlined animate-spin">progress_activity</span>
				Iniciando sesión...
			`;

            // Hide previous errors
            errorMessage?.classList.add("hidden");

            try {
                const { user, error } = await signInAdmin(email, password);

                if (error || !user) {
                    throw new Error(
                        error?.message || "Error al iniciar sesión",
                    );
                }

                // Success - redirect to admin dashboard
                window.location.href = "/admin";
            } catch (error: any) {
                // Show error
                if (errorMessage) {
                    const errorText = errorMessage.querySelector("p");
                    if (errorText) {
                        errorText.textContent =
                            error.message ||
                            "Credenciales incorrectas. Por favor, intenta de nuevo.";
                    }
                    errorMessage.classList.remove("hidden");
                }

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
					<span class="material-symbols-outlined">login</span>
					Iniciar Sesión
				`;
            }
        });
    </script>
</Layout>

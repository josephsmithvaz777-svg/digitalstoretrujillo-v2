---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

const title = "My Account - DigitalStoreTrujillo";
const description = "View your order history and credentials";
---

<Layout title={title} description={description}>
    <Header />

    <main
        class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12"
    >
        <!-- Loading State -->
        <div
            id="loading"
            class="flex flex-col items-center justify-center py-20"
        >
            <span
                class="material-symbols-outlined text-primary text-5xl animate-spin mb-4"
                >progress_activity</span
            >
            <p class="text-text-muted">Loading your account...</p>
        </div>

        <!-- Success Modal for Email Confirmation -->
        <div
            id="confirmation-modal"
            class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        >
            <div
                class="bg-card-dark border border-border-dark rounded-xl max-w-sm w-full p-6 shadow-2xl transform transition-all scale-100 text-center relative"
            >
                <!-- Close Button -->
                <button
                    id="close-modal-btn"
                    class="absolute top-4 right-4 text-text-muted hover:text-white"
                >
                    <span class="material-symbols-outlined">close</span>
                </button>

                <div
                    class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"
                >
                    <span
                        class="material-symbols-outlined text-green-500 text-3xl"
                        >mark_email_read</span
                    >
                </div>

                <h3 class="text-white text-xl font-bold mb-2">
                    Account Confirmed!
                </h3>
                <p class="text-text-muted text-sm leading-relaxed mb-6">
                    Thank you for verifying your email. You now have full access
                    to your account and purchases.
                </p>

                <button
                    id="modal-continue-btn"
                    class="w-full bg-primary hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-all"
                >
                    Continue Shopping
                </button>
            </div>
        </div>

        <!-- Credentials Modal -->
        <div
            id="credentials-modal"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto"
        >
            <div class="relative w-full max-w-md my-8">
                <button
                    id="close-credentials-modal"
                    class="absolute -top-10 right-0 text-white hover:text-primary transition-colors z-50"
                >
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
                
                <div id="credentials-container" class="space-y-6">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-8">
            <!-- Header -->
            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-border-dark pb-6"
            >
                <div>
                    <h1 class="text-3xl font-black text-white tracking-tight">
                        My Account
                    </h1>
                    <p class="text-text-muted mt-1">
                        Welcome back, <span
                            id="user-display-name"
                            class="text-white font-bold"></span>
                    </p>
                </div>
                <button
                    id="logout-btn"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-card-dark border border-border-dark text-text-muted hover:text-white hover:border-red-500 hover:bg-red-500/10 transition-all"
                >
                    <span class="material-symbols-outlined">logout</span>
                    Sign Out
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content: Orders -->
                <div class="lg:col-span-2 space-y-6">
                    <h2
                        class="text-xl font-bold text-white flex items-center gap-2"
                    >
                        <span class="material-symbols-outlined text-primary"
                            >shopping_bag</span
                        >
                        Order History
                    </h2>

                    <div id="orders-container" class="space-y-4">
                        <!-- Orders will be injected here -->
                    </div>
                </div>

                <!-- Sidebar: Profile & Support -->
                <div class="space-y-6">
                    <!-- Profile Card -->
                    <div
                        class="bg-card-dark border border-border-dark rounded-xl p-6"
                    >
                        <h3
                            class="text-white font-bold mb-4 flex items-center gap-2"
                        >
                            <span class="material-symbols-outlined text-primary"
                                >person</span
                            >
                            Profile Details
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-text-muted text-xs">Full Name</p>
                                <p
                                    id="profile-name"
                                    class="text-white text-sm font-bold"
                                >
                                </p>
                            </div>
                            <div>
                                <p class="text-text-muted text-xs">Email</p>
                                <p
                                    id="profile-email"
                                    class="text-white text-sm break-all"
                                >
                                </p>
                            </div>
                            <div>
                                <p class="text-text-muted text-xs">
                                    Phone Number
                                </p>
                                <p
                                    id="profile-phone"
                                    class="text-white text-sm"
                                >
                                </p>
                            </div>
                            <div>
                                <p class="text-text-muted text-xs">
                                    Member Since
                                </p>
                                <p id="profile-date" class="text-white text-sm">
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Support Card -->
                    <div
                        class="bg-card-dark border border-border-dark rounded-xl p-6"
                    >
                        <h3
                            class="text-white font-bold mb-4 flex items-center gap-2"
                        >
                            <span class="material-symbols-outlined text-primary"
                                >support_agent</span
                            >
                            Need Help?
                        </h3>
                        <p class="text-text-muted text-sm mb-4">
                            If you have issues with your orders or credentials,
                            please contact our support team.
                        </p>
                        <a
                            href="/contact"
                            class="flex items-center justify-center gap-2 w-full py-2 bg-[#25D366]/10 text-[#25D366] rounded-lg border border-[#25D366]/20 hover:bg-[#25D366]/20 transition-all font-bold text-sm"
                        >
                            WhatsApp Support
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Auth State (Should redirect, but fallback) -->
        <div
            id="no-auth"
            class="hidden flex flex-col items-center justify-center py-20 text-center"
        >
            <div
                class="w-20 h-20 bg-card-dark rounded-full flex items-center justify-center mb-6 border border-border-dark"
            >
                <span class="material-symbols-outlined text-text-muted text-4xl"
                    >lock</span
                >
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Access Denied</h2>
            <p class="text-text-muted mb-8 max-w-md">
                Please sign in to view your account.
            </p>
            <a
                href="/login"
                class="bg-primary hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition-all"
            >
                Sign In
            </a>
        </div>
    </main>

    <Footer />
</Layout>

<script>
    import { supabase, getUserOrders } from "../../lib/supabase";
    import { cartCount } from "../../stores/cart";

    const loading = document.getElementById("loading");
    const dashboard = document.getElementById("dashboard");
    const noAuth = document.getElementById("no-auth");
    const userDisplayName = document.getElementById("user-display-name");
    const profileName = document.getElementById("profile-name");
    const profileEmail = document.getElementById("profile-email");
    const profilePhone = document.getElementById("profile-phone");
    const profileDate = document.getElementById("profile-date");
    const ordersContainer = document.getElementById("orders-container");
    const logoutBtn = document.getElementById("logout-btn");

    // Credentials Modal
    const credentialsModal = document.getElementById("credentials-modal");
    const credentialsContainer = document.getElementById("credentials-container");
    const closeCredentialsBtn = document.getElementById("close-credentials-modal");

    // Modal elements
    const confirmationModal = document.getElementById("confirmation-modal");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const modalContinueBtn = document.getElementById("modal-continue-btn");

    // Check for email confirmation hash
    // Supabase redirects with #access_token=...&type=signup or recovery
    const hasAuthHash =
        window.location.hash &&
        (window.location.hash.includes("type=signup") ||
            window.location.hash.includes("access_token"));

    if (hasAuthHash) {
        confirmationModal?.classList.remove("hidden");
        // We don't clean URL immediately here to allow Supabase to process it
    }

    // Modal actions
    const closeModal = () => {
        confirmationModal?.classList.add("hidden");
        // Clean URL after closing modal
        if (hasAuthHash) {
            window.history.replaceState(null, "", window.location.pathname);
        }
    };

    closeModalBtn?.addEventListener("click", closeModal);
    modalContinueBtn?.addEventListener("click", () => {
        closeModal();

        // If there are items in the cart, redirect to checkout
        if (cartCount.get() > 0) {
            window.location.href = "/checkout";
        } else {
            window.location.href = "/"; // Go to home to shop
        }
    });

    function formatDate(dateString: string) {
        return new Date(dateString).toLocaleDateString("es-PE", {
            year: "numeric",
            month: "short",
            day: "numeric",
        });
    }

    function formatPrice(amount: number, currency: string = "PEN") {
        const symbol = currency === "USD" ? "$" : "S/";
        return `${symbol} ${parseFloat(amount.toString()).toFixed(2)}`;
    }

    function getStatusColor(status: string) {
        switch (status) {
            case "completed":
                return "text-green-500 border-green-500/20 bg-green-500/10";
            case "processing":
                return "text-blue-500 border-blue-500/20 bg-blue-500/10";
            case "cancelled":
                return "text-red-500 border-red-500/20 bg-red-500/10";
            default:
                return "text-yellow-500 border-yellow-500/20 bg-yellow-500/10";
        }
    }

    async function init() {
        // If we have a hash, give Supabase a moment to process it
        if (hasAuthHash) {
            console.log("Waiting for auth hash processing...");
            // We rely on onAuthStateChange to handle the success case

            // Fallback: If nothing happens after 3 seconds, redirect to login
            setTimeout(() => {
                if (
                    !document
                        .getElementById("dashboard")
                        ?.classList.contains("hidden")
                )
                    return;
                console.log("Auth hash timeout, checking user manually...");
                checkUserAndRender();
            }, 3000);
            return;
        }

        checkUserAndRender();
    }

    async function checkUserAndRender() {
        const {
            data: { user },
        } = await supabase.auth.getUser();

        if (!user) {
            loading?.classList.add("hidden");
            noAuth?.classList.remove("hidden");
            // Optional: Redirect after a delay or let user click
            // window.location.href = "/login";
            return;
        }

        renderDashboard(user);
    }

    async function renderDashboard(user: any) {
        // Hide loading, show dashboard
        loading?.classList.add("hidden");
        noAuth?.classList.add("hidden");
        dashboard?.classList.remove("hidden");

        // Fill user info
        const metadata = user.user_metadata || {};
        const fullName = metadata.full_name || "User";
        const phone = metadata.phone || "Not provided";

        if (userDisplayName) userDisplayName.textContent = fullName;
        if (profileName) profileName.textContent = fullName;
        if (profileEmail) profileEmail.textContent = user.email || "-";
        if (profilePhone) profilePhone.textContent = phone;
        if (profileDate) profileDate.textContent = formatDate(user.created_at);

        // Fetch orders
        const orders = await getUserOrders();
        renderOrders(orders);
    }

    function renderOrders(orders: any[]) {
        if (!ordersContainer) return;

        if (orders.length === 0) {
            ordersContainer.innerHTML = `
                <div class="bg-card-dark border border-border-dark rounded-xl p-8 text-center">
                    <div class="w-16 h-16 bg-background-dark rounded-full flex items-center justify-center mx-auto mb-4 border border-border-dark">
                        <span class="material-symbols-outlined text-text-muted text-3xl">shopping_cart_off</span>
                    </div>
                    <h3 class="text-white font-bold text-lg mb-2">No orders yet</h3>
                    <p class="text-text-muted text-sm mb-6">Looks like you haven't placed any orders yet.</p>
                    <a href="/" class="text-primary hover:text-white font-bold text-sm transition-colors">Start Shopping</a>
                </div>
            `;
        } else {
            ordersContainer.innerHTML = orders
                .map(
                    (order) => `
                <div class="bg-card-dark border border-border-dark rounded-xl overflow-hidden hover:border-primary/50 transition-colors">
                    <div class="p-4 border-b border-border-dark flex flex-wrap justify-between items-center gap-4 bg-background-dark/50">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                            <div>
                                <p class="text-text-muted text-xs uppercase tracking-wider">Order Placed</p>
                                <p class="text-white text-sm font-medium">${formatDate(order.created_at)}</p>
                            </div>
                            <div>
                                <p class="text-text-muted text-xs uppercase tracking-wider">Order #</p>
                                <p class="text-white text-sm font-medium">${order.order_number}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="px-3 py-1 rounded-full text-xs font-bold border ${getStatusColor(order.status)} capitalize">
                                ${order.status}
                            </span>
                            <span class="text-white font-bold">
                                ${formatPrice(order.total, order.currency)}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3">
                            ${
                                Array.isArray(order.items)
                                    ? order.items
                                          .map(
                                              (item: any) => `
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded bg-background-dark border border-border-dark flex-shrink-0 overflow-hidden">
                                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-white text-sm font-medium truncate">${item.title}</h4>
                                        <p class="text-text-muted text-xs">Qty: ${item.quantity}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-white text-sm font-medium">${formatPrice(item.price * item.quantity, order.currency)}</p>
                                    </div>
                                </div>
                            `,
                                          )
                                          .join("")
                                    : '<p class="text-text-muted text-sm">Items details unavailable</p>'
                            }
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-border-dark flex justify-between items-center">
                            <div>
                                <p class="text-xs text-text-muted">Payment Method: <span class="text-white capitalize">${order.payment_method}</span></p>
                                <p class="text-xs text-text-muted">Payment Status: <span class="${order.payment_status === "verified" ? "text-green-500" : "text-yellow-500"} capitalize font-medium">${order.payment_status}</span></p>
                            </div>
                            
                            ${
                                (order.status === "completed" || order.payment_status === "verified") && order.delivery_info
                                    ? `
                                <button 
                                    class="view-credentials-btn text-primary hover:text-white text-sm font-bold flex items-center gap-1 transition-colors"
                                    data-delivery-info='${JSON.stringify(order.delivery_info)}'
                                >
                                    <span class="material-symbols-outlined text-sm">key</span>
                                    View Credentials
                                </button>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                </div>
            `,
                )
                .join("");

            // Add event listeners to buttons
            document.querySelectorAll(".view-credentials-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const info = JSON.parse(btn.getAttribute("data-delivery-info") || "[]");
                    openCredentialsModal(info);
                });
            });
        }
    }

    function openCredentialsModal(info: any[]) {
        if (!credentialsContainer) return;

        credentialsContainer.innerHTML = info.map((item) => `
            <div class="bg-gradient-to-br from-[#1a1a1a] to-[#0f0f0f] border border-gray-800 rounded-2xl overflow-hidden shadow-2xl relative">
                <!-- Top Glow -->
                <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                
                <!-- Header -->
                <div class="p-6 text-center border-b border-gray-800 relative overflow-hidden">
                    <div class="absolute inset-0 bg-primary/5 blur-3xl"></div>
                    <h3 class="text-2xl font-black text-white italic tracking-tighter uppercase relative z-10 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                        ${item.title}
                    </h3>
                </div>

                <!-- Credentials Body -->
                <div class="p-6 space-y-4">
                    <!-- Email -->
                    <div class="bg-black/40 rounded-lg p-3 border border-gray-800 flex justify-between items-center group hover:border-gray-600 transition-colors">
                        <div class="overflow-hidden mr-2">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Correo / Usuario</p>
                            <p class="text-white font-mono text-sm select-all truncate">${item.account_email}</p>
                        </div>
                        <button class="text-gray-500 hover:text-white copy-btn flex-shrink-0" data-text="${item.account_email}">
                            <span class="material-symbols-outlined text-lg">content_copy</span>
                        </button>
                    </div>

                    <!-- Password -->
                    <div class="bg-black/40 rounded-lg p-3 border border-gray-800 flex justify-between items-center group hover:border-gray-600 transition-colors">
                        <div class="overflow-hidden mr-2">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Contrase√±a</p>
                            <p class="text-white font-mono text-sm select-all truncate">${item.account_password}</p>
                        </div>
                        <button class="text-gray-500 hover:text-white copy-btn flex-shrink-0" data-text="${item.account_password}">
                            <span class="material-symbols-outlined text-lg">content_copy</span>
                        </button>
                    </div>

                    <!-- Main Visual (PIN/Profile) -->
                    ${item.image_url || item.pin ? `
                    <div class="relative mt-6 mb-6 group cursor-pointer perspective-1000">
                        <div class="bg-[#1e1e1e] rounded-xl overflow-hidden border border-gray-700 shadow-[0_0_30px_rgba(0,0,0,0.5)] relative">
                            ${item.image_url ? `<img src="${item.image_url}" class="w-full aspect-[4/5] object-cover object-top opacity-90 group-hover:opacity-100 transition-opacity duration-500">` : `<div class="w-full aspect-[4/5] bg-gray-900"></div>`}
                            
                            <!-- Gradient Overlay for PIN visibility -->
                            <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-transparent z-10"></div>

                            <div class="absolute inset-0 flex flex-col items-center justify-center z-20 pointer-events-none">
                                ${item.pin ? `
                                <div class="text-center transform -translate-y-8">
                                    <h4 class="text-yellow-400 font-black text-5xl tracking-tighter drop-shadow-[0_4px_0_rgba(0,0,0,1)] stroke-black mb-4" style="-webkit-text-stroke: 1.5px black; text-shadow: 0 4px 8px rgba(0,0,0,0.5);">PIN: ${item.pin}</h4>
                                    <div class="w-16 h-16 bg-black/60 backdrop-blur-md rounded-full flex items-center justify-center mx-auto border border-white/20 shadow-xl">
                                        <span class="material-symbols-outlined text-white text-3xl">lock</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Rules -->
                    <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4">
                        <h4 class="text-red-400 font-bold text-xs uppercase tracking-widest mb-2 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">warning</span>
                            Reglas de Uso
                        </h4>
                        <div class="text-gray-400 text-xs space-y-1">
                            ${(item.instructions || '').split('\n').map((line: string) => `<p>${line}</p>`).join('')}
                        </div>
                    </div>

                    <!-- Expiration -->
                    <div class="text-center pt-2">
                        <div class="inline-flex items-center gap-2 bg-gray-800/50 px-4 py-1.5 rounded-full border border-gray-700">
                            <span class="material-symbols-outlined text-gray-400 text-sm">event</span>
                            <span class="text-gray-400 text-xs font-medium">Vencimiento:</span>
                            <span class="text-white text-xs font-bold">${item.expiration_date ? formatDate(item.expiration_date) : 'Indefinido'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join("");

        credentialsModal?.classList.remove("hidden");
        document.body.style.overflow = "hidden";

        // Add copy functionality
        document.querySelectorAll(".copy-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const text = btn.getAttribute("data-text");
                if (text) {
                    navigator.clipboard.writeText(text);
                    const icon = btn.querySelector("span");
                    if (icon) {
                        icon.textContent = "check";
                        setTimeout(() => icon.textContent = "content_copy", 2000);
                    }
                }
            });
        });
    }

    closeCredentialsBtn?.addEventListener("click", () => {
        credentialsModal?.classList.add("hidden");
        document.body.style.overflow = "auto";
    });

    // Close on backdrop click
    credentialsModal?.addEventListener("click", (e) => {
        if (e.target === credentialsModal) {
            credentialsModal.classList.add("hidden");
            document.body.style.overflow = "auto";
        }
    });

    // Listen for Auth Changes (This catches the hash redirect login)
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_IN" || event === "TOKEN_REFRESHED") {
            if (session?.user) {
                renderDashboard(session.user);
            }
        } else if (event === "SIGNED_OUT") {
            window.location.href = "/login";
        }
    });

    init();

    // Logout
    logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "/login";
    });
</script>

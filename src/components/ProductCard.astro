---
interface Props {
    title: string;
    price: number; // USD price
    pricePEN?: number; // PEN price
    originalPrice?: number; // USD original
    originalPricePEN?: number; // PEN original
    renewablePrice?: number; // USD renewable
    renewablePricePEN?: number; // PEN renewable
    image: string;
    badge?: string;
    badgeColor?: string;
    badgeTextColor?: string;
    showBadge?: boolean;
    discountBadge?: string;
    discountBadgeColor?: string;
    discountBadgeTextColor?: string;
    showDiscountBadge?: boolean;
    showRenewablePrice?: boolean;
    category?: string;
    seller?: string;
    rating?: number;
    reviewCount?: number;
    stockQuantity?: number;
    inStock?: boolean;
    productUrl?: string;
}

const {
    title,
    price,
    pricePEN,
    originalPrice,
    originalPricePEN,
    renewablePrice,
    renewablePricePEN,
    image,
    badge,
    badgeColor,
    badgeTextColor,
    showBadge = true,
    discountBadge,
    discountBadgeColor,
    discountBadgeTextColor,
    showDiscountBadge = true,
    showRenewablePrice = true,
    category = "Digital Product",
    seller = "DigitalStore",
    rating = 5,
    reviewCount = 0,
    stockQuantity = 0,
    inStock = true,
    productUrl = "/product",
} = Astro.props;
---

<div
    class:list={[
        "group flex flex-col bg-[#1a1a1a] rounded-2xl overflow-hidden hover:scale-[1.02] transition-all duration-300 shadow-lg hover:shadow-2xl hover:shadow-primary/20",
        !inStock && "opacity-75",
    ]}
>
    <!-- Badges Container -->
    <div class="absolute top-3 left-3 z-10 flex gap-2">
        {
            discountBadge && showDiscountBadge && inStock && (
                <span
                    class="text-xs font-black px-3 py-1.5 rounded-lg shadow-lg"
                    style={`background-color: ${discountBadgeColor || "var(--color-primary)"}; color: ${discountBadgeTextColor || "white"}`}
                >
                    {discountBadge}
                </span>
            )
        }
        {
            badge && showBadge && (
                <span
                    class="text-xs font-black px-3 py-1.5 rounded-lg shadow-lg"
                    style={`background-color: ${badgeColor || "#FFD700"}; color: ${badgeTextColor || (badgeColor ? (parseInt(badgeColor.replace("#", ""), 16) > 0xffffff / 2 ? "black" : "white") : "black")}`}
                >
                    {badge}
                </span>
            )
        }
        {
            !inStock && (
                <span
                    class="bg-gray-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg prod-out-of-stock"
                    data-i18n="product_out_of_stock"
                >
                    AGOTADO
                </span>
            )
        }
    </div>

    <!-- Product Image -->
    <div
        class="relative aspect-square overflow-hidden bg-gradient-to-br from-gray-800 to-gray-900"
    >
        <img
            src={image}
            alt={title}
            class:list={[
                "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110",
                !inStock && "grayscale",
            ]}
        />
        {
            inStock && (
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
            )
        }
    </div>

    <!-- Product Info -->
    <div class="p-4 flex flex-col gap-3 bg-[#1a1a1a]">
        <!-- Seller/Category -->
        <div class="flex items-center gap-2 text-xs">
            <span class="text-text-muted uppercase tracking-wider"
                >{seller}</span
            >
            <span class="text-border-dark">•</span>
            <span class="text-text-muted flex items-center gap-1">
                <span class="material-symbols-outlined text-sm"
                    >deployed_code</span
                >
                {stockQuantity}
            </span>
        </div>

        <!-- Title -->
        <h3
            class:list={[
                "font-bold text-base leading-tight line-clamp-2 min-h-[2.5rem]",
                inStock ? "text-white" : "text-gray-400",
            ]}
        >
            {title}
        </h3>

        <!-- Rating -->
        {
            inStock && (
                <div class="flex items-center gap-2">
                    <div class="flex text-[#FFD700]">
                        {[...Array(5)].map((_, i) => (
                            <span
                                class="material-symbols-outlined text-sm"
                                style={
                                    i < rating
                                        ? "font-variation-settings: 'FILL' 1"
                                        : ""
                                }
                            >
                                star
                            </span>
                        ))}
                    </div>
                    {reviewCount > 0 && (
                        <span class="text-xs text-text-muted">
                            ({reviewCount}){" "}
                            <a
                                href="#"
                                class="text-primary hover:underline prod-review-link"
                                data-i18n="product_review"
                            >
                                Dejar reseña
                            </a>
                        </span>
                    )}
                </div>
            )
        }

        <!-- Pricing -->
        <div class="flex flex-col gap-1">
            {
                originalPrice && inStock && (
                    <div class="flex items-center gap-2">
                        <span
                            class="text-sm text-text-muted line-through product-original-price"
                            data-price-usd={originalPrice}
                            data-price-pen={originalPricePEN}
                        >
                            ${originalPrice.toFixed(2)}
                        </span>
                    </div>
                )
            }
            {
                renewablePrice && inStock && showRenewablePrice && (
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500 text-sm">
                            autorenew
                        </span>
                        <span
                            class="text-sm text-green-400 font-semibold product-renewable-price"
                            data-price-usd={renewablePrice}
                            data-price-pen={renewablePricePEN}
                        >
                            Renovable: ${renewablePrice.toFixed(2)}
                        </span>
                    </div>
                )
            }
            <div class="flex items-baseline gap-2">
                <span
                    class:list={[
                        "text-2xl font-black product-price",
                        inStock ? "text-white" : "text-gray-500",
                    ]}
                    data-price-usd={price}
                    data-price-pen={pricePEN}
                >
                    $ {price.toFixed(2)}
                </span>
            </div>
        </div>

        <!-- CTA Button -->
        <a
            href={inStock ? productUrl : "#"}
            class:list={[
                "w-full py-3 rounded-lg font-black text-sm uppercase tracking-wide transition-all duration-300 transform active:scale-95 shadow-lg text-center block",
                inStock
                    ? "bg-primary hover:bg-red-700 text-white hover:shadow-xl hover:shadow-primary/50"
                    : "bg-gray-700 text-gray-400 cursor-not-allowed pointer-events-none",
            ]}
        >
            <span
                class="btn-text"
                data-i18n={inStock ? "product_buy_now" : "product_notify_me"}
                >{inStock ? "COMPRAR AHORA" : "NOTIFICARME"}</span
            >
        </a>
    </div>
</div>

<script>
    import { initializeCurrency, userCurrency } from "../stores/currencyStore";
    import { getPrice, CURRENCIES } from "../lib/currency";
    import { currentLanguage, useTranslation } from "../stores/i18nStore";

    // Initialize currency detection
    initializeCurrency();

    // Update prices when currency changes
    const updatePrices = () => {
        const currency = userCurrency.get();
        const symbol = CURRENCIES[currency].symbol;
        const lang = currentLanguage.get();
        const t = useTranslation();

        // Main prices
        document.querySelectorAll(".product-price").forEach((el) => {
            const priceUSDAttr = el.getAttribute("data-price-usd");
            const pricePENAttr = el.getAttribute("data-price-pen");

            const priceUSD = parseFloat(priceUSDAttr || "0");
            const pricePEN =
                pricePENAttr &&
                pricePENAttr !== "null" &&
                pricePENAttr !== "undefined"
                    ? parseFloat(pricePENAttr)
                    : null;

            const price = getPrice(priceUSD, pricePEN, currency);
            el.textContent = `${symbol} ${price.toFixed(2)}`;
        });

        // Original prices
        document.querySelectorAll(".product-original-price").forEach((el) => {
            const priceUSDAttr = el.getAttribute("data-price-usd");
            const pricePENAttr = el.getAttribute("data-price-pen");

            const priceUSD = parseFloat(priceUSDAttr || "0");
            const pricePEN =
                pricePENAttr &&
                pricePENAttr !== "null" &&
                pricePENAttr !== "undefined"
                    ? parseFloat(pricePENAttr)
                    : null;

            const price = getPrice(priceUSD, pricePEN, currency);
            el.textContent = `${symbol} ${price.toFixed(2)}`;
        });

        // Renewable prices
        document.querySelectorAll(".product-renewable-price").forEach((el) => {
            const priceUSDAttr = el.getAttribute("data-price-usd");
            const pricePENAttr = el.getAttribute("data-price-pen");

            const priceUSD = parseFloat(priceUSDAttr || "0");
            const pricePEN =
                pricePENAttr &&
                pricePENAttr !== "null" &&
                pricePENAttr !== "undefined"
                    ? parseFloat(pricePENAttr)
                    : null;

            const price = getPrice(priceUSD, pricePEN, currency);
            el.textContent = `${t("product_renewable")}: ${symbol}${price.toFixed(2)}`;
        });
    };

    // Update text translations
    const updateTranslations = () => {
        const t = useTranslation();

        // Out of stock badge
        document.querySelectorAll(".prod-out-of-stock").forEach((el) => {
            el.textContent = t("product_out_of_stock");
        });

        // Review link
        document.querySelectorAll(".prod-review-link").forEach((el) => {
            el.textContent = t("product_review");
        });

        // Buttons
        document.querySelectorAll(".group").forEach((card) => {
            const btnText = card.querySelector(".btn-text");
            const isOutOfStock = card.classList.contains("opacity-75"); // Check if out of stock based on class

            if (btnText) {
                if (isOutOfStock) {
                    btnText.textContent = t("product_notify_me");
                } else {
                    btnText.textContent = t("product_buy_now");
                }
            }
        });

        // Price prefix (Renovable)
        updatePrices();
    };

    // Subscribe to changes
    userCurrency.subscribe(updatePrices);
    currentLanguage.subscribe(updateTranslations);

    // Listen for custom events
    window.addEventListener("currency-changed", updatePrices);
    window.addEventListener("language-changed", updateTranslations);
</script>

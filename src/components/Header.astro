---
import CartIcon from "./CartIcon.astro";
// Header component for DigitalStoreTrujillo
---

<header
    class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-border-dark px-4 lg:px-40 py-3 bg-background-dark sticky top-0 z-50"
>
    <div class="flex items-center gap-8 w-full">
        <a
            href="/"
            class="flex items-center gap-4 text-white hover:opacity-80 transition-opacity"
        >
            <div class="size-8 text-primary">
                <span class="material-symbols-outlined text-4xl"
                    >local_mall</span
                >
            </div>
            <h2
                class="text-white text-lg font-bold leading-tight tracking-[-0.015em] hidden sm:block"
            >
                DigitalStoreTrujillo
            </h2>
        </a>
        <form
            action="/search"
            method="get"
            class="hidden md:flex flex-col min-w-40 !h-10 max-w-64"
        >
            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                <div
                    class="text-text-muted flex border-none bg-border-dark items-center justify-center pl-4 rounded-l-lg border-r-0"
                >
                    <span class="material-symbols-outlined text-[24px]"
                        >search</span
                    >
                </div>
                <input
                    name="q"
                    type="search"
                    id="header-search-input"
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border-none bg-border-dark focus:border-none h-full placeholder:text-text-muted px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                    placeholder="Search products..."
                />
            </div>
        </form>
    </div>
    <div class="flex flex-1 justify-end gap-4 lg:gap-8 items-center">
        <div class="hidden lg:flex items-center gap-9">
            <a
                class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors"
                data-i18n="nav_home"
                href="/">Home</a
            >
            <a
                class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors"
                data-i18n="nav_software"
                href="/category/software">Software</a
            >
            <a
                class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors"
                data-i18n="nav_games"
                href="/category/games">Games</a
            >
            <a
                class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors"
                data-i18n="nav_services"
                href="/category/services">Services</a
            >
        </div>
        <div class="flex gap-2 items-center">
            <a
                id="auth-button"
                href="/login"
                class="flex min-w-[84px] md:min-w-[84px] sm:min-w-[40px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 md:px-4 bg-primary hover:bg-red-700 transition-colors text-white text-sm font-bold leading-normal tracking-[0.015em] gap-2"
            >
                <span class="material-symbols-outlined text-xl">person</span>
                <span
                    class="hidden md:inline truncate"
                    id="auth-text"
                    data-i18n="auth_signin">Sign In</span
                >
            </a>

            <button
                id="header-logout-btn"
                class="hidden w-10 h-10 items-center justify-center rounded-lg bg-card-dark border border-border-dark hover:border-red-500 hover:text-red-500 transition-colors text-white"
                title="Sign Out"
            >
                <span class="material-symbols-outlined">logout</span>
            </button>

            <!-- Language Switcher -->
            <button
                id="language-toggle"
                class="flex items-center gap-2 px-2 md:px-3 h-10 rounded-lg bg-card-dark border border-border-dark hover:border-text-muted transition-all group"
                title="Change language / Cambiar idioma"
            >
                <span
                    id="lang-text"
                    class="text-xs font-bold text-white uppercase hidden md:inline"
                    >EN</span
                >
                <span
                    class="material-symbols-outlined text-[18px] text-text-muted group-hover:text-white transition-colors"
                >
                    language
                </span>
            </button>

            <!-- Currency Switcher -->
            <button
                id="currency-toggle"
                class="flex items-center gap-2 px-2 md:px-3 h-10 rounded-lg bg-card-dark border border-border-dark hover:border-text-muted transition-all group"
                title="Cambiar moneda"
            >
                <span id="currency-flag" class="text-lg hidden md:inline"
                ></span>
                <span
                    id="currency-code"
                    class="text-xs font-bold text-white uppercase hidden md:inline"
                ></span>
                <span
                    class="material-symbols-outlined text-[18px] text-text-muted group-hover:text-white transition-colors"
                >
                    swap_horiz
                </span>
            </button>

            <CartIcon />
        </div>
    </div>
</header>

<script>
    import { supabase } from "../lib/supabase";
    import { useTranslation, currentLanguage } from "../stores/i18nStore";

    const authButton = document.getElementById(
        "auth-button",
    ) as HTMLAnchorElement;
    const authText = document.getElementById("auth-text");
    const logoutBtn = document.getElementById("header-logout-btn");

    if (authButton && authText && logoutBtn) {
        // Function to update UI state
        const updateUI = (session: any) => {
            const t = useTranslation();
            if (session) {
                authText.textContent = t("auth_account");
                authText.setAttribute("data-i18n", "auth_account");
                authButton.href = "/account";
                authButton.classList.remove("bg-primary", "hover:bg-red-700");
                authButton.classList.add(
                    "bg-card-dark",
                    "border",
                    "border-border-dark",
                    "hover:border-primary",
                );

                // Show logout button
                logoutBtn.classList.remove("hidden");
                logoutBtn.classList.add("flex");
            } else {
                authText.textContent = t("auth_signin");
                authText.setAttribute("data-i18n", "auth_signin");
                authButton.href = "/login";
                authButton.classList.add("bg-primary", "hover:bg-red-700");
                authButton.classList.remove(
                    "bg-card-dark",
                    "border",
                    "border-border-dark",
                    "hover:border-primary",
                );

                // Hide logout button
                logoutBtn.classList.add("hidden");
                logoutBtn.classList.remove("flex");
            }
        };

        // Check initial session
        supabase.auth.getSession().then(({ data: { session } }) => {
            updateUI(session);
        });

        // Listen for language changes to update auth text
        currentLanguage.subscribe(() => {
            supabase.auth.getSession().then(({ data: { session } }) => {
                updateUI(session);
            });
        });

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            updateUI(session);
        });

        // Handle Logout
        logoutBtn.addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "/login";
        });
    }
    // Currency & Language Logic
    import {
        userCurrency,
        updateCurrency,
        initializeCurrency,
    } from "../stores/currencyStore";
    import { updateLanguage, initializeLanguage } from "../stores/i18nStore";
    import { CURRENCIES } from "../lib/currency";

    const currencyToggle = document.getElementById("currency-toggle");
    const currencyFlag = document.getElementById("currency-flag");
    const currencyCode = document.getElementById("currency-code");

    // i18n Elements
    const languageToggle = document.getElementById("language-toggle");
    const langText = document.getElementById("lang-text");

    if (currencyToggle && currencyFlag && currencyCode) {
        // Initialize stores
        initializeCurrency();
        initializeLanguage();

        const updateCurrencyUI = (currency: any) => {
            const config =
                CURRENCIES[currency as keyof typeof CURRENCIES] ||
                CURRENCIES.USD;
            currencyCode.textContent = config.code;
            currencyFlag.textContent = config.code === "PEN" ? "ðŸ‡µðŸ‡ª" : "ðŸ‡ºðŸ‡¸";
        };

        // Subscribe to store changes
        userCurrency.subscribe((currency) => {
            updateCurrencyUI(currency);
        });

        // Handle toggle click
        currencyToggle.addEventListener("click", () => {
            const current = userCurrency.get();
            const next = current === "PEN" ? "USD" : "PEN";
            updateCurrency(next);
        });
    }

    // Language Toggle logic
    if (languageToggle && langText) {
        const updateLanguageUI = (lang: string) => {
            langText.textContent = lang.toUpperCase();
        };

        // Subscribe to language changes
        currentLanguage.subscribe((lang) => {
            updateLanguageUI(lang);
        });

        languageToggle.addEventListener("click", () => {
            const current = currentLanguage.get();
            const next = current === "en" ? "es" : "en";
            updateLanguage(next);
        });
    }
</script>
